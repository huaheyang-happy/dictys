# Dictys：单细胞转录组和染色质可及性数据动态基因调控网络推断工具

## 项目简介

Dictys 是一个强大的计算工具，旨在从单细胞转录组（scRNA-seq）和单细胞染色质可及性（scATAC-seq）数据中推断动态基因调控网络（Gene Regulatory Networks, GRNs）。它能够捕捉细胞状态转变过程中的基因调控变化，并提供对细胞分化、发育或疾病进展等生物学过程的深入理解。Dictys 的核心在于其能够将高维单细胞数据映射到低维轨迹上，并在此轨迹上进行动态网络推断和分析。

## 核心原理概述

Dictys 的工作流程可以概括为以下几个主要步骤：

1.  **数据预处理：** 对原始单细胞数据进行质量控制和标准化，为后续分析做准备。
2.  **低维表示学习：** 将高维的基因表达数据或染色质可及性数据映射到低维空间，捕获细胞状态的主要变异模式。
3.  **轨迹推断：** 在低维空间中构建细胞状态转变的轨迹，通常表现为树状结构，反映细胞分化或发育路径。
4.  **轨迹上的细胞子集划分（滑窗）：** 沿着推断出的细胞轨迹，通过滑动窗口的方式划分出重叠的细胞子集。
5.  **动态网络推断：** 在每个细胞子集内推断基因调控网络，从而捕捉网络在细胞状态转变过程中的动态变化。
6.  **网络分析与可视化：** 对推断出的动态网络进行进一步的分析和可视化，揭示关键调控事件和基因。

## 详细解释

### 1. 低维表示的生成原理

Dictys 在其基因调控网络重建模块中实现了低维表示的学习。这主要体现在 `src/dictys/network.py` 文件中的 `model_covariance` 类及其派生类 `model_ou`。

**核心思想：** Dictys 不像传统的降维方法（如 PCA, UMAP, t-SNE）那样直接输出一个二维或三维的坐标，而是通过概率模型学习数据内在的低维协方差结构。它假设真实的基因表达水平服从一个低秩的多元正态分布，并通过这个分布来捕获数据的主要变异。

**具体实现：**
在 `model_covariance` 类中，关键参数是 `sigma_G_nd` 和 `npc`：
*   `sigma_G_nd`：这是一个低秩的非对角协方差矩阵因子。在多元正态分布中，协方差矩阵描述了不同基因表达水平之间的相互关系。`sigma_G_nd` 捕获了这些关系中主要的、低维度的变异模式。通过学习这个低秩因子，模型能够有效地将高维的基因表达数据投影到一个更低维的潜在空间。
*   `npc` (number of low rank off-diagonal degrees of freedom)：这个参数直接控制了 `sigma_G_nd` 的秩，从而决定了学习到的低维表示的维度。例如，如果 `npc` 设置为 10，那么模型将尝试用 10 个潜在因子来解释基因表达数据中的主要变异。这 10 个因子构成了数据的低维表示。

**与传统降维的区别：**
传统的降维方法通常直接将数据点投影到低维坐标系中。而 Dictys 的方法是基于概率模型的，它学习的是数据在低维空间中的统计特性（即协方差结构），而不是直接的坐标。这种方法在推断基因调控网络时更为自然，因为它直接与基因之间的相互作用（通过协方差体现）相关联。

### 2. 轨迹的生成原理

轨迹的生成是 Dictys 理解细胞状态转变的关键步骤，主要由 `src/dictys/traj.py` 文件中的 `trajectory` 类负责。

**核心思想：** Dictys 将细胞状态的转变建模为低维空间中的一个树状轨迹。这个轨迹由一系列节点（代表细胞状态或分支点）和连接这些节点的边（代表状态转变路径）组成。

**具体实现：**
`trajectory` 类的构建可以通过两种主要方式：
*   **从边和长度构建：** 最直接的方式是提供 `edges`（边的起始和结束节点ID）和 `lens`（每条边的长度）。这通常适用于已经预先定义了轨迹结构和距离的情况。
*   **从距离矩阵构建 (`fromdist` 方法)：** 更常见的情况是，Dictys 从细胞（或样本点）到轨迹上各个节点（或预定义的细胞状态）的距离矩阵来推断轨迹。
    *   输入：`dists` (一个 `n_sample` x `n_node` 的矩阵，表示每个细胞到每个节点的距离) 和 `edges` (预定义的节点连接关系)。
    *   过程：`trajectory.len_edge` 方法会根据这些距离计算出每条边的长度。例如，对于一条连接节点 A 和节点 B 的边，其长度可以通过计算所有细胞到 A 和 B 的距离差的最大值来估计。
    *   一旦边的长度确定，`trajectory` 对象就会被初始化，并构建一个 `networkx.Graph` 对象来表示轨迹的拓扑结构。Dictys 强制要求轨迹是无环且连通的树状结构，以确保细胞状态转变的单向性和连续性。

**轨迹的意义：** 推断出的轨迹为后续的动态网络分析提供了上下文。它允许 Dictys 沿着细胞分化或发育的时间轴（伪时间）来观察基因调控网络的演变。

### 3. 滑窗的实现原理

滑窗（Moving Window）是 Dictys 捕捉基因调控网络动态变化的关键技术，它允许在细胞轨迹的不同阶段推断局部网络。这主要由 `src/dictys/traj.py` 文件中的 `point` 类的 `subsets` 方法实现，并在 `src/dictys/dynamic.py` 文件中被调用。

**核心思想：** 沿着细胞轨迹，Dictys 并非一次性推断整个数据集的网络，而是将轨迹划分为一系列重叠的“窗口”或“子集”。每个子集包含一定数量的细胞，这些细胞在轨迹上是相邻的。通过在每个子集内独立推断基因调控网络，Dictys 能够揭示网络在细胞状态转变过程中的细微变化。

**具体实现 (`point.subsets` 方法)：**
`subsets` 方法接收以下关键参数来定义滑窗的行为：
*   `ncell` (int)：每个细胞子集（窗口）中包含的细胞数量。这是窗口的“大小”。
*   `noverlap` (int)：相邻细胞子集之间必须重叠的细胞数量。这个参数确保了窗口之间的连续性，使得动态网络的变化能够平滑过渡。
*   `dmax` (float)：相邻细胞子集中心之间的最大伪时间距离。这是一个软上限，用于控制窗口的间隔，确保相邻窗口不会离得太远。

**滑窗步骤：**
1.  **初始化子集：** 首先，`subsets` 方法会从轨迹上的每个节点开始，选择距离该节点最近的 `ncell` 个细胞作为初始的细胞子集。
2.  **细胞位置微扰：** 为了避免完全重叠的细胞导致计算问题，`point.perturb()` 方法会对细胞在轨迹上的位置进行微小的随机扰动。
3.  **沿边生成子集：** 对于轨迹上的每条边，`subsets` 方法会沿着这条边上的细胞，逐步生成新的细胞子集。
4.  **冗余子集移除：** 在生成过程中，会检查新生成的子集是否与已有的子集重复，或者是否不满足 `noverlap` 和 `dmax` 的要求。不符合条件的子集会被移除，以确保子集的有效性和非冗余性。
5.  **输出：** 最终，`subsets` 方法返回一系列重叠的细胞子集，每个子集都包含其对应的细胞ID、在轨迹上的位置以及与其他子集的邻居关系。

### 4. 窗口大小的确定

窗口的大小（`ncell`）、重叠程度（`noverlap`）和相邻窗口的最大距离（`dmax`）是 Dictys 进行动态网络推断的关键超参数。它们的取值对最终结果有显著影响。

**参数含义：**
*   **`ncell` (每个窗口的细胞数量)：**
    *   **大 `ncell`：** 窗口包含更多细胞，提供更稳定的统计推断，但可能平滑掉细微的动态变化，降低时间分辨率。适用于细胞数量较少或变化较平缓的轨迹。
    *   **小 `ncell`：** 窗口包含较少细胞，能够捕捉更精细的动态变化，提高时间分辨率，但可能导致统计推断不稳定，易受噪声影响。适用于细胞数量充足且变化剧烈的轨迹。
*   **`noverlap` (相邻窗口的重叠细胞数量)：**
    *   **大 `noverlap`：** 窗口之间重叠度高，使得动态网络的变化更加平滑连续，减少了窗口边界效应。
    *   **小 `noverlap`：** 窗口之间重叠度低，可能导致网络变化显得更“跳跃”，但计算效率可能更高。
*   **`dmax` (相邻窗口中心的最大伪时间距离)：**
    *   这个参数用于限制相邻窗口在伪时间轴上的距离。如果两个潜在的相邻窗口中心距离超过 `dmax`，即使它们满足 `noverlap` 的要求，也可能被视为不合格的相邻窗口。
    *   **大 `dmax`：** 允许窗口间隔更大，可能导致一些中间状态被跳过。
    *   **小 `dmax`：** 强制窗口更紧密地排列，确保对轨迹的密集覆盖。

**如何确定窗口大小：**
Dictys 的代码中没有提供这些参数的默认值或自动确定方法。这意味着用户需要根据以下因素来选择合适的参数：

1.  **数据集特性：**
    *   **细胞总数：** 如果细胞总数较少，`ncell` 不宜过大，否则会导致窗口数量过少。
    *   **轨迹复杂性：** 如果轨迹分支多、变化快，可能需要较小的 `ncell` 和 `dmax` 来捕捉细节。
    *   **噪声水平：** 噪声较高的数据可能需要较大的 `ncell` 来提高统计稳定性。
2.  **生物学问题：**
    *   **关注宏观变化：** 如果关注细胞状态的大的转变，可以选择较大的 `ncell`。
    *   **关注微观动态：** 如果关注细胞分化过程中的细微调控事件，可能需要较小的 `ncell`。
3.  **计算资源：**
    *   较小的 `ncell` 和 `dmax` 会生成更多的窗口，从而增加计算量。
4.  **经验和实验：**
    *   通常，这些参数需要通过试错和经验来确定。可以尝试不同的组合，并评估推断网络的生物学合理性和稳定性。例如，可以从文献中类似研究的参数设置开始，然后进行微调。
    *   可视化每个窗口推断出的网络，并观察网络随轨迹的变化趋势，可以帮助判断参数设置是否合理。

## 数据预处理

在进行低维表示学习和轨迹推断之前，Dictys 会对原始单细胞数据进行必要的预处理。这部分功能主要由 `src/dictys/preproc.py` 文件提供。

**主要功能包括：**
*   **样本/细胞选择：** `selects_rna` 和 `selects_atac` 函数允许用户根据外部提供的细胞名称列表来筛选RNA或ATAC数据中的细胞。这对于整合不同实验或去除不需要的细胞类型非常有用。
*   **质量控制（QC）：** `qc_reads` 函数对读数矩阵进行严格的质量控制。它会迭代地过滤掉低质量的基因和细胞，例如：
    *   基因：总读数过低、表达细胞数量过少或表达细胞比例过低。
    *   细胞：总读数过低、表达基因数量过少或表达基因比例过低。
    通过这些QC步骤，Dictys 确保输入数据的高质量，从而提高后续分析的准确性和可靠性。

## 网络重建

网络重建是 Dictys 的核心功能之一，它在每个细胞子集内推断基因调控网络。这部分功能主要由 `src/dictys/network.py` 文件提供。

**主要功能包括：**
*   **概率模型：** Dictys 使用基于 Pyro 库构建的概率模型（如 `model_ou`）来推断基因调控网络。这些模型能够处理单细胞数据的稀疏性和噪声特性。
*   **Ornstein-Uhlenbeck (OU) 过程：** `model_ou` 模型在 `model_covariance` 的基础上，进一步利用 OU 过程的稳态分布来建模基因表达的协方差矩阵。OU 过程常用于描述具有回归均值特性的随机过程，这与基因调控的动态平衡相符。通过这种方式，模型能够从基因表达数据中推断出基因之间的因果调控关系（即网络边权重）。
*   **随机变分推断（SVI）：** 模型参数的优化通过 SVI 进行，这是一种高效的贝叶斯推断方法，适用于大规模数据集。
*   **网络后处理：** `indirect` 和 `normalize` 函数用于对推断出的网络进行后处理，例如计算基因扰动的间接效应，或对网络边权重进行归一化，以便更好地解释和比较。

## 总结

Dictys 提供了一个全面的框架，用于从单细胞数据中推断动态基因调控网络。它通过学习数据的低维协方差结构来捕获细胞状态的主要变异，并在推断出的细胞轨迹上应用滑动窗口技术来捕捉网络在伪时间上的动态演变。通过严谨的概率建模和灵活的参数设置，Dictys 旨在为研究人员提供强大的工具，以揭示细胞命运决定和疾病进展背后的复杂调控机制。
